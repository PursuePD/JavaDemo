## 单机数据库机制

#### 服务器中的数据库

redis服务器将所有数据库都保存在数据库状态redis.h/redisServer结构的db数组中。db中每个都是redis.h/redisDb结构，每个这个结构都代表一个数据库。默认创建16个数据库。

示例：

![redisServer](img\redisServer.png)

切换数据库:SELECT x (x:第x+1个数据库)

#### 数据库键控件

redisDb结构的dict字典保存了数据库中的所有键值对，我们将这个字典称为键空间。

- 键空间的键就是数据库的键，每个键都是一个字符串对象。
- 键空间的值就是数据库的值，每个值可以是字符串对象、列表对象、哈希表对象、集合对象、和有序集合对象中的任意一种redis对象。

示例：

![redisDb](img\redisDb.png)

##### 读写数据库时的维护操作

- 在读取一个键之后(读操作和写操作都要对键进行读取),服务器会根据键是否存在来更新服务器的键空间命中( hit)次数或键空间不命中( miss)次数，这两个值可以在INFO stats命令的keyspace_ hits 属性和keyspace_ misses 属性中查看。
- 在读取一个键之后，服务器会更新键的LRU (最后一次使用)时间，这个值可以用于计算键的闲置时间，使用OBJECT idletime <key>命令可以查看键key的闲置时间。
- 如果服务器在读取一个键时发现该键已经过期，那么服务器会先删除这个过期键,然后才执行余下的其他操作
- 如果有客户端使用WATCH命令监视了某个键，那么服务器在对被监视的键进行修改之后，会将这个键标记为脏(dirty),从而让事务程字注意到这个键已经被修改过。
- 服务器每次修改一个键之后，都会对脏( dirty )键计数器的值增1,这个计数器会触发服务器的持久化以及复制操作。
- 如果服务器开启了数据库通知功能，那么在对键进行修改之后，服务器将按配置发送相应的数据库通知。

#### 键的生存时间或过期时间

通过EXPIRE命令或者PEXPIRE命令,客户端可以以秒或者毫秒精度为数据库中的某个键设置生存时间( Time To Live, TTL),在经过指定的秒数或者毫秒数之后，服务器就会自动删除生存时间为0的键。

如：EXPIRE key 5 (5秒后过期)  PEXPIRE key 5 (5毫秒)

- 注意：SETEX命令可以在设置一个字符串键的同时为键设置过期时间，因为这个命令是一个类型限定的命令(只能用于字符串键),所以本章不会对这个命令进行介绍，但SETEX命令设置过期时间的原理和本章介绍的EXPIRE命令设置过期时间的原理是完全一样的。

也可以通过EXPIREAT和PEXPIREAT命令，以毫秒或者秒给数据库某个键设置过期时间（expire time） 这个过期时间是个时间戳。

如：EXPIREAT key 1587030965 (秒) PEXPIREAT key 1587030965000 (毫秒)

##### 过期时间的保存

redisDb结构的expire字典保存了数据库中所有的过期时间。

- 过期字典的键是一个指针，这个指针指向键空间中的某个对象（数据库键）。
- 过期字典的值是一个long long类型的数据，一个毫秒时间的unix时间戳。

数据库例子：

![expire_redisDb](img\expire_redisDb.png)

其他命令：

- **PERSIST** 命令可以移除一个键的时间
- **TTL** 命令以秒为单位返回键的剩余时间 **PTTL** 则以毫秒为单位

过期键的判定：

1. 检查键是否存在于过期字典，如果存在，那么取得过期时间。
2. 检查当前UNIX时间戳是否大于键的过期时间。如果是的话，那么键已过期，否在未过期。

##### 过期键的删除策略

总共3种删除策略

> - 定时删除：在设置键的过期时间的同时，创建一个定时器(timer),让定时器在键的过期时间来临时，立即执行对键的删除操作。
>   - 对内存友好，占用cup太多时间，影响服务器吞吐量
> - 惰性删除：放任键过期不管，但是每次从键空间中获取键时，都检查取得的键是否过期，如果过期的话，就删除该键;如果没有过期，就返回该键。
>   - 对内存不友好，浪费太多内存有内存泄漏风险
> - 定期删除：定期是前两种的一种整合和折中，每隔一段时间，程序就对数据库进行一次检查，删除里面的过期键。至于要删除多少过期键，以及要检查多少个数据库，则由算法决定。

##### Redis的过期键删除策略

redis服务器使用的是惰性删除和定期删除两种策略。

- 惰性删除的实现

  所有读写数据库命令在执行之前都会调用expireIfNeeded函数进行检查；

  - 如果键已经过期，那么函数会将该键从数据库删除。
  - 如果未过期，那么函数不做动作。

- 定期删除的实现

  每当Redis的服务周期性调用redis.c/serverCron函数时,activeExpireCycle函数就会被调用。在规定时间内分多次遍历服务器的各个数据库，检查过期时间，删除过期键。

  - 函数每次运行时，都从一定数量的数据库中取出一-定数量的随机键进行检查，并删除其中的过期键。
  - 全局变量current_db会记录当前activeExpireCycle函数检查的进度，并在下一次activeExpireCycle函数调用时，接着上一次的进度进行处理。比如说，如果当前activeExpireCycle函数在遍历10号数据库时返回了，那么下次activeExpireCycle函数执行时，将从11号数据库开始查找并删除过期键。
  - 随着activeExpireCycle函数的不断执行，服务器中的所有数据库都会被检查一遍，这时函数将current_ db变量重置为0，然后再次开始新一轮的检查工作。

##### AOF、RDB和复制功能对过期键的处理


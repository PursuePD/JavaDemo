## 对象

​	redis没有使用sds，链表，字典，跳跃表，整数集合，压缩列表这些数据结构直接实现键值对数据库，而且构建了5种对象（字符串对象，列表对象，哈希对象，集合对象，有序集合对象），每种对象至少包含一种数据结构。

​	好处是在不同场景使用不同的数据结构，提高效率。

#### 对象的类型和编码

| 类型         | 对象                          | 编码                                           | OBJECT ENCODING输出 |
| ------------ | ----------------------------- | ---------------------------------------------- | ------------------- |
| REDIS_STRING | REDIS_ENCODING_INT            | 使用整数值实现的字符串对象                     | int                 |
| REDIS_STRING | REDIS_ENCODING_EMBSTR         | 使用embstr编码的简单动态字符串实现的字符串对象 | embstr              |
| REDIS_STRING | **REDIS_ENCODING_RAW**        | 使用简单动态字符串实现的字符串对象             | raw                 |
| REDIS_LIST   | **REDIS_ENCODING_ZIPLIST**    | 使用压缩列表实现的列表对象                     | ziplist             |
| REDIS_LIST   | **REDIS_ENCODING_LINKEDLIST** | 使用双端链表实现的列表对象                     | linkedlist          |
| REDIS_HASH   | **REDISl_ENCODING_ZIPLIST**   | 使用压缩列表实现的哈希对象                     | ziplist             |
| REDIS_HASH   | **REDIS_ENCODING_HT**         | 使用字典实现的哈希对象                         | hashtable           |
| REDIS_SET    | **REDIS_ENCODING_INTSET**     | 使用整数集合实现的集合对象                     | intset              |
| REDIS_SET    | **REDIS_ENCODING_HT**         | 使用字典实现的集合对象                         | hashtable           |
| REDIS_ZSET   | **REDISl_ENCODING_ZIPLIST**   | 使用压缩列表实现的有序集合对象                 | ziplist             |
| REDIS_ZSET   | **REDISl_ENCODING_SKIPLIST**  | 使用跳跃表和字典实现的有序集合对象             | skiplist            |

#### 字符串对象（REDIS_STRING）

| 对象                   | 编码                                           | 备注                                                      |
| ---------------------- | ---------------------------------------------- | --------------------------------------------------------- |
| REDIS_ENCODING_INT     | 使用整数值实现的字符串对象                     | 当保存对象是整数值并且可以使用long类型表示，对应编码为int |
| REDIS_ENCODING_EMBSTR  | 使用embstr编码的简单动态字符串实现的字符串对象 | 保存对象是字符串时，且字符串长度小于等于32字节            |
| **REDIS_ENCODING_RAW** | 使用简单动态字符串实现的字符串对象             | 保存对象是字符串时，且字符串长度大于32字节                |

**字符串命令:**

![str](img\string_commd.png)

#### 列表对象（REDIS_LIST）

​	列表对象是唯一一种会被其他4种类型对象嵌套的对象。

​	**编码转换**：当同时满足一下2个条件时，列表对象使用ziplist编码。 否则使用linkedlist编码（这两个条件可以通过修改配置修改值）

- 列表对象所保存的字符串长度都小于64字节
- 保存的元素个数小于512；

**列表命令：**

![list](img\list_commd.png)

#### 哈希对象（REDIS_HASH）

​	哈希对象的编码可以是ziplist和hashtable、

​	**ziplist**作为编码实现时，当有新的键值对加入到哈希对象时，程序会先将键压入到压缩列表表尾，然后讲值压入表尾。所以

  - 同一键值对在压缩列表肯定是挨着一起的。键在前值在后。

  - 先添加的在表头，后添加的在表尾。

​	**hashtable**作为编码实现时，哈希对象中的每个键值对都使用一个字典键值对来保存。

- 字典每个键都是字符串对象，对象中保存了键值对的键。
- 字典每个值都是字符串对象，对象中保存了键值对的值。

​	**编码转换**（可配置）：当同时满足一下2个条件时，哈希对象使用ziplist编码。 

- 键和值的字符串长度都小于64字节
- 键值对数量小于512；

**哈希命令：**

![hashtable_commd](img\hashtable_commd.png)

#### 集合对象（REDIS_SET）

​	集合对象编码可以是intset或者hashtable

​	**编码转换**（可配置）：当同时满足一下2个条件时，集合对象使用intset编码。 

- 所有元素都是整数值
- 数量小于512；

**集合命令**

![set_commd](img\set_commd.png)

#### 有序集合对象（REDIS_ZSET）

​	集合对象编码可以是ziplist或者skiplist

​	当使用zpilist编码时，每个集合元素使用两个紧挨一起的压缩列表节点来保存。第一个保存元素的成员member，第二个保存分值score。

**为什么有序集合需要同时使用跳跃表和字典来实现?**

​	在理论上，有序集合可以单独使用字典或者跳跃表的其中一种数据结构来实现，但无论单独使用字典还是跳跃表，在性能上对比起同时使用字典和跳跃表都会有所降低。举个例子，如果我们只使用字典来实现有序集合，那么虽然以0(1)复杂度查找成员的分值这一特性会被保留，但是，因为字典以无序的方式来保存集合元素，所以每次在执行范围型操作一比 如ZRANK、ZRANGE等命令时，程序都需要对字典保存的所有元素进行排序，完成这种排序需要至少0(NIlogN)时间复杂度，以及额外的0(N)内存空间(因为要创建一个数组来保存排序后的元素)。

​	另一方面，如果我们只使用跳跃表来实现有序集合，那么跳跃表执行范围型操作的所有优点都会被保留，但因为没有了字典，所以根据成员查找分值这一操作的复杂度将从0(1)上升为0(logN)。因为以上原因，为了让有序集合的查找和范围型操作都尽可能快地执行，Redis 选择了同时使用字典和跳跃表两种数据结构来实现有序集合。

**有序集合同时被保存在字典和跳跃表中**

![zset_obj](img\zset_obj.png)

​	**编码转换**（可配置）：当同时满足一下2个条件时，有序集合对象使用zpilist编码。 

- 元素数量小于128

- 保存的元素成员的长度都小于64字节

  
  
  **有序集合命令**

![zset_commd](img\zset_commd.png)



#### 检查类型和命令多态

​	redis命令分为两种，一种是通用命令，比如DEL命令，EXPIRE命令，TYPE命令，OBJECT命令。还有一种是针对特定类型的命令。

类型检查：

1. 收到发送的命令（LLEN命令），先检查键key的值对象是否是列表对象
2. 判断编码
3. 执行对应编码的实现

#### **内存回收**

通过引用计数来判断，适当时候释放对象并进行内存回收。

1. 创建对象，引用计数器初始化为1
2. 被一个新程序使用，计数器+1
3. 不再被使用，计数器-1
4. 变为0时，对象所占用的内存会被释放

#### 对象共享

对象的引用计数属性还带有对象共享的作用。**Redis会共享值为0到9999的字符串对象。**

比如键A和键B都包含整数值100的字符串对象，2键的指针都指向同一个对象，该对象的引用计数为2。

![obj_refcount](img\obj_refcount.png)

#### 对象的空转时长

lru熟悉记录了最后一次被访问的时间。空转时长就等于当前时间减去lru计算得出。

**作用**：当内存占用超过配置的maxmemory是，执行相关策略，回收空转时间较长的键。



#### 重点回顾

- Redis数据库中的每个键值对的键和值都是一个对象。
- Redis共有字符串、列表、哈希、集合、有序集合五种类型的对象，每种类型的对象至少都有两种或以上的编码方式，不同的编码可以在不同的使用场景上优化对象的使用效率。
- 服务器在执行某些命令之前，会先检查给定键的类型能否执行指定的命令，而检查一个键的类型就是检查键的值对象的类型。
- Redis的对象系统带有引用计数实现的内存回收机制，当一 个对象不再被使用时，该对象所占用的内存就会被自动释放。
- Redis会共享值为0到9999的字符串对象。
- 对象会记录自己的最后一次被访问的时间，这个时间可以用于计算对象的空转时间。





### 引用

 [1]《Redis设计与实现》.(黄健宏)
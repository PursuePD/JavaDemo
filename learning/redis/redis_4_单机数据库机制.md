## 单机数据库机制

#### 服务器中的数据库

redis服务器将所有数据库都保存在数据库状态redis.h/redisServer结构的db数组中。db中每个都是redis.h/redisDb结构，每个这个结构都代表一个数据库。默认创建16个数据库。

示例：

![redisServer](img\redisServer.png)

切换数据库:SELECT x (x:第x+1个数据库)

#### 数据库键控件

redisDb结构的dict字典保存了数据库中的所有键值对，我们将这个字典称为键空间。

- 键空间的键就是数据库的键，每个键都是一个字符串对象。
- 键空间的值就是数据库的值，每个值可以是字符串对象、列表对象、哈希表对象、集合对象、和有序集合对象中的任意一种redis对象。

示例：

![redisDb](img\redisDb.png)

##### 读写数据库时的维护操作

- 在读取一个键之后(读操作和写操作都要对键进行读取),服务器会根据键是否存在来更新服务器的键空间命中( hit)次数或键空间不命中( miss)次数，这两个值可以在INFO stats命令的keyspace_ hits 属性和keyspace_ misses 属性中查看。
- 在读取一个键之后，服务器会更新键的LRU (最后一次使用)时间，这个值可以用于计算键的闲置时间，使用OBJECT idletime <key>命令可以查看键key的闲置时间。
- 如果服务器在读取一个键时发现该键已经过期，那么服务器会先删除这个过期键,然后才执行余下的其他操作
- 如果有客户端使用WATCH命令监视了某个键，那么服务器在对被监视的键进行修改之后，会将这个键标记为脏(dirty),从而让事务程字注意到这个键已经被修改过。
- 服务器每次修改一个键之后，都会对脏( dirty )键计数器的值增1,这个计数器会触发服务器的持久化以及复制操作。
- 如果服务器开启了数据库通知功能，那么在对键进行修改之后，服务器将按配置发送相应的数据库通知。

#### 键的生存时间或过期时间

通过EXPIRE命令或者PEXPIRE命令,客户端可以以秒或者毫秒精度为数据库中的某个键设置生存时间( Time To Live, TTL),在经过指定的秒数或者毫秒数之后，服务器就会自动删除生存时间为0的键。

如：EXPIRE key 5 (5秒后过期)  PEXPIRE key 5 (5毫秒)

- 注意：SETEX命令可以在设置一个字符串键的同时为键设置过期时间，因为这个命令是一个类型限定的命令(只能用于字符串键),所以本章不会对这个命令进行介绍，但SETEX命令设置过期时间的原理和本章介绍的EXPIRE命令设置过期时间的原理是完全一样的。

也可以通过EXPIREAT和PEXPIREAT命令，以毫秒或者秒给数据库某个键设置过期时间（expire time） 这个过期时间是个时间戳。

如：EXPIREAT key 1587030965 (秒) PEXPIREAT key 1587030965000 (毫秒)

##### 过期时间的保存

redisDb结构的expire字典保存了数据库中所有的过期时间。

- 过期字典的键是一个指针，这个指针指向键空间中的某个对象（数据库键）。
- 过期字典的值是一个long long类型的数据，一个毫秒时间的unix时间戳。

数据库例子：

![expire_redisDb](img\expire_redisDb.png)